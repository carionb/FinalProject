<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Final Project - SG60: Visualizing Singapore's 60 Years of Development</title>
	<!-- Tailwind CSS -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
	<!-- D3.js -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js" defer></script>
	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<!-- MapLibre for 3D Map -->
	<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" />
	<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
	<!-- Chart.js â€” load *before* your code, no defer -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
	<style>
		/* Reset and basic */
		* { margin: 0; padding: 0; box-sizing: border-box; }
		html, body { height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
		body { background: #f9f9f9; color: #333; }
		
		/* Navigation styling */
		nav {
		  background: white;
		  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		  width: 100%;
		  z-index: 1000;
		}
		
		.nav-fixed {
		  position: fixed;
		  top: 0;
		}
		
		.nav-item { 
		  cursor: pointer; 
		  padding: 0.75rem 1.25rem;
		  transition: all 0.3s ease;
		  position: relative;
		  font-weight: 500;
		}
		
		.nav-item:hover {
		  color: #e53e3e;
		}
		
		.nav-item.active { 
		  color: #e53e3e; 
		  font-weight: 600; 
		}
		
		.nav-item.active:after {
		  content: '';
		  position: absolute;
		  bottom: 0;
		  left: 0;
		  width: 100%;
		  height: 3px;
		  background-color: #e53e3e;
		}
		
		/* Content area padding */
		.content-padding {
		  padding-top: 60px;
		}
		
		/* Section styling */
		section { 
		  scroll-margin-top: 70px;
		  padding: 2rem;
		  background: white;
		  border-radius: 8px;
		  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
		  margin-bottom: 2rem;
		}
		
		/* Module placeholder styling */
		.module-placeholder {
		  border: 2px dashed #cbd5e0;
		  border-radius: 6px;
		  padding: 2rem;
		  text-align: center;
		  background-color: #f7fafc;
		}
		
		/* Header animation */
		@keyframes gradientAnimation {
		  0% {background-position: 0% 50%}
		  50% {background-position: 100% 50%}
		  100% {background-position: 0% 50%}
		}
		
		.animated-header {
		  background: linear-gradient(90deg, #c53030, #e53e3e, #f56565);
		  background-size: 200% 200%;
		  animation: gradientAnimation 8s ease infinite;
		}
		
		/* Hover effects */
		.hover-effect:hover {
		  transform: translateY(-3px);
		  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
		}
		
		/* Data source cards */
		.data-source-card {
		  background-color: rgba(255, 255, 255, 0.1);
		  border-radius: 6px;
		  padding: 1rem;
		  transition: all 0.3s ease;
		}
		
		.data-source-card:hover {
		  background-color: rgba(255, 255, 255, 0.15);
		  transform: translateY(-2px);
		}
		
		.data-source-link {
		  color: #f0b3b3;
		  text-decoration: none;
		  transition: color 0.2s ease;
		}
		
		.data-source-link:hover {
		  color: #ffffff;
		  text-decoration: underline;
		}
		
		/* 3D Map Styles */
		#map {
		  height: 500px;
		  width: 100%;
		  position: relative;
		  z-index: 1;
		}
		
		/* Control Panel */
		.control-panel {
		      position:absolute; top:20px; left:20px;
		      background:rgba(255,255,255,0.9);
		      padding:16px; border-radius:12px;
		      box-shadow:0 4px 16px rgba(0,0,0,0.2);
		      z-index:2; min-width:280px;
		      transition: all 0.3s ease;
		    }
		    .control-panel.collapsed {
		      width: 40px;
		      min-width: 40px;
		      padding: 10px;
		      border-radius: 50%;
		    }
		    .control-group { 
		      margin-bottom:16px; 
		      transition: opacity 0.3s ease;
		    }
		    .control-panel.collapsed .control-group {
		      opacity: 0;
		      height: 0;
		      overflow: hidden;
		      margin: 0;
		    }
		
		        .control-panel.collapsed .value-display,
		.control-panel.collapsed .decade-markers {
		  display: none;
		}
		
		.control-label {
		  position: relative;
		  z-index: 1;
		  display:block; margin-bottom:8px;
		      font-size:15px; color:#444; font-weight:600;
		}
		
		#year-value {
		  position: absolute;
		}
		
		   
		    .slider { width:100%; }
		    .value-display {
		      float:right; font-weight:500; color:#333;
		    }
		    
		    /* Toggle Button */
		    .toggle-panel {
		      position: absolute;
		      top: 2px;
		      right: 2px;
		      width: 28px;
		      height: 28px;
		      display: flex;
		      align-items: center;
		      justify-content: center;
		      background: #4a90e2;
		      border: none;
		      border-radius: 50%;
		      cursor: pointer;
		      color: white;
		      font-weight: bold;
		      transition: all 0.3s ease;
		      margin: 4px;
		      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
		      z-index: 3;
		    }
		    .toggle-panel:hover {
		      background: #357abd;
		      transform: scale(1.1);
		    }
		    .control-panel.collapsed .toggle-panel {
		      transform: rotate(180deg);
		    }
		
		    /* ====================
		       Remote-Style Controls
		       ==================== */
		    .view-mode-selector {
		      display: flex;
		      margin-bottom: 12px;
		      border-radius: 8px;
		      overflow: hidden;
		      border: 1px solid #ddd;
		    }
		    .view-mode-btn {
		      flex: 1;
		      padding: 8px 4px;
		      background: #f5f5f5;
		      border: none;
		      font-size: 12px;
		      font-weight: 600;
		      cursor: pointer;
		      transition: all 0.2s;
		    }
		    .view-mode-btn.active {
		      background: #4a90e2;
		      color: white;
		    }
		    .view-mode-btn:not(:last-child) {
		      border-right: 1px solid #ddd;
		    }
		    .view-mode-btn:hover:not(.active) {
		      background: #e5e5e5;
		    }
		    
		    .remote-controls {
		      display:grid;
		      grid-template:
		        "up    up    up"      40px
		        "left reset right"    40px
		        "down  down  down"    40px
		        / 60px  60px  60px;
		      gap:8px; justify-items:center;
		    }
		    .remote-controls button {
		      border:none; border-radius:8px;
		      background:linear-gradient(135deg,#4a90e2,#357abd);
		      cursor:pointer; width:100%; height:100%;
		      display:flex; align-items:center; justify-content:center;
		      transition:background .2s,transform .2s;
		    }
		    .remote-controls button:hover {
		      background:linear-gradient(135deg,#357abd,#2a5a8f);
		      transform:scale(1.1);
		    }
		    #tilt-up     { grid-area: up;     }
		    #reset-view  { grid-area: reset;  }
		    #tilt-down   { grid-area: down;   }
		    #rotate-left { grid-area: left;   }
		    #rotate-right{ grid-area: right;  }
		    .remote-controls svg {
		      width:16px; height:16px; fill:rgba(255,255,255,0.9);
		    }
		
		    /* =======================
		       Timeline Decade Markers
		       ======================= */
		           .timeline-container {
		  position: relative;
		  padding-top: 30px;
		  margin-top: 10px;
		}
		    .decade-markers {
		      display: flex;
		      justify-content: space-between;
		      margin-bottom: 5px;
		      padding: 0 2px;
		    }
		    .decade-marker {
		      font-size: 10px;
		      color: #666;
		      position: relative;
		      text-align: center;
		      cursor: pointer;
		      font-weight: 500;
		    }
		    .decade-marker:hover {
		      color: #4a90e2;
		    }
		    .decade-marker::after {
		      content: '';
		      position: absolute;
		      height: 6px;
		      width: 2px;
		      background: #999;
		      bottom: -8px;
		      left: 50%;
		      transform: translateX(-50%);
		    }
		
		    /* =========
		       Legend
		       ========= */
		    .legend {
		      position:absolute; bottom:80px; right:10px;
		      background:rgba(255,255,255,0.9);
		      padding:12px; border-radius:8px;
		      font-size:13px; box-shadow:0 4px 12px rgba(0,0,0,0.15);
		      z-index:2;
		      transition: all 0.3s ease;
		    }
		    .legend-item {
		      display:flex; align-items:center; margin-bottom:6px;
		    }
		    .legend-color {
		      width:16px; height:16px; margin-right:8px;
		      border-radius:3px;
		    }
		    .legend.collapsed {
		      transform: translateY(calc(100% - 36px));
		    }
		    .legend-header {
		      display: flex;
		      justify-content: space-between;
		      align-items: center;
		      margin-bottom: 8px;
		      cursor: pointer;
		    }
		    .legend-header h3 {
		      margin: 0;
		      font-size: 14px;
		    }
		    .legend-content {
		      transition: max-height 0.3s ease, opacity 0.3s ease;
		      max-height: 300px;
		      overflow: hidden;
		      opacity: 1;
		    }
		    .legend.collapsed .legend-content {
		      max-height: 0;
		      opacity: 0;
		    }
		    .toggle-legend {
		      width: 18px;
		      height: 18px;
		      display: flex;
		      align-items: center;
		      justify-content: center;
		      border-radius: 50%;
		      background: #eee;
		      cursor: pointer;
		      transition: transform 0.3s ease;
		    }
		    .legend.collapsed .toggle-legend {
		      transform: rotate(180deg);
		    }
		
		 /* info panel */
		  .building-info-panel {
		margin-top: 16px;
		padding-top: 16px;
		border-top: 1px solid #e2e8f0;
		  }
		
		  .building-info-content {
		background: #f8fafc;
		border-radius: 6px;
		padding: 12px;
		border: 1px solid #e2e8f0;
		font-size: 13px;
		min-height: 100px;
		  }
		
		  .building-info-row {
		display: flex;
		margin-bottom: 6px;
		  }
		
		  .building-info-label {
		font-weight: 500;
		width: 60px;
		color: #4a5568;
		  }
		
		  .building-info-value {
		flex-grow: 1;
		color: #1a202c;
		  }
		
		  .no-building-selected {
		color: #718096;
		font-style: italic;
		text-align: center;
		padding: 8px 0;
		  }
		
		       /* ================
		       Statistics Panel
		       ================*/
		    .stats-panel {
		      position: absolute;
		      top: 50px;
		      right: 10px;
		      background: rgba(255,255,255,0.9);
		      padding: 12px;
		      border-radius: 8px;
		      font-size: 13px;
		      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
		      z-index: 2;
		      min-width: 180px;
		      transition: all 0.3s ease;
		    }
		    .stats-header {
		      display: flex;
		      justify-content: space-between;
		      align-items: center;
		      margin-bottom: 8px;
		      cursor: pointer;
		    }
		    .stats-header h3 {
		      margin: 0;
		      font-size: 14px;
		    }
		    .stats-content {
		      transition: max-height 0.3s ease, opacity 0.3s ease;
		      max-height: 300px;
		      overflow: hidden;
		      opacity: 1;
		    }
		    
		    .stat-item {
		      display: flex;
		      justify-content: space-between;
		      margin-bottom: 6px;
		    }
		    .stat-value {
		      font-weight: 600;
		    }


                    #overview iframe {
                      width: 100%;
                      height: calc(100vh - 120px);
                      border: none;
                     }

		
	</style>
</head>
<body class="flex flex-col min-h-screen">
	<!-- HEADER -->
	<header class="animated-header text-white py-8 text-center">
		<div class="container mx-auto px-4">
			<h1 class="text-4xl font-bold mb-2">SG60: Visualizing Singapore's Development</h1>
			<p class="text-xl">Exploring Singapore's remarkable transformation since 1965</p>
		</div>
	</header>
	<!-- NAVIGATION -->
	<nav id="main-nav">
		<div class="container mx-auto">
			<ul class="flex justify-center space-x-2 md:space-x-8">
				<li><a href="#overview" class="nav-item active flex items-center"><i class="fas fa-home mr-2"></i> Overview</a></li>
				<li><a href="#map3d" class="nav-item flex items-center"><i class="fas fa-map-marked-alt mr-2"></i> 3D Map</a></li>
				<li><a href="#population" class="nav-item flex items-center"><i class="fas fa-users mr-2"></i> Population</a></li>
			</ul>
		</div>
	</nav>
	<!-- MAIN CONTENT -->
			<!-- Overview -->
			<section id="overview">
				<iframe
				  src="https://prudhvinsk.github.io/SG-60/"
				  style="width:100%; height:80vh; border:none;"
				  sandbox="allow-scripts allow-same-origin"
				></iframe>
			</section>
	<main id="main-content" class="flex-grow container mx-auto py-8 px-4">
		<div class="max-w-5xl mx-auto space-y-12">
			<!-- 3D Housing Map -->
			<section id="map3d" class="transition-all duration-300 hover-effect">
				<h2 class="text-2xl font-bold mb-6 text-red-600 border-b pb-2">3D Housing Map</h2>
				<p class="mb-4">Explore Singapore's HDB buildings in an interactive 3D view. Use the controls to navigate and filter by construction year.</p>
				<div class="relative" style="height: 600px;">
					<!-- Map Container -->
					<div id="map-container" class="relative" style="height: 600px;">
						<div id="map" style="height: 100%; width: 100%;"></div>
						<!-- Statistics Panel -->
						<div class="stats-panel" id="stats-panel">
							<div class="stats-header">
								<h3>HDB Statistics</h3>
							</div>
							<div class="stats-content">
								<div class="stat-item">
									<span>Total Buildings:</span>
									<span id="stat-total" class="stat-value">-</span>
								</div>
								<div class="stat-item">
									<span>Current View:</span>
									<span id="stat-current" class="stat-value">-</span>
								</div>
								<div class="stat-item">
									<span>Avg Floor Count:</span>
									<span id="stat-avg-floor" class="stat-value">-</span>
								</div>
								<div class="stat-item">
									<span>Latest Year:</span>
									<span id="stat-latest" class="stat-value">-</span>
								</div>
							</div>
						</div>
						<!-- Control Panel -->
						<div class="control-panel" id="control-panel">
							<button class="toggle-panel" id="toggle-panel" title="Toggle Panel">
								<svg width="16" height="16" viewBox="0 0 24 24" fill="white">
									<path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path>
								</svg>
							</button>
							<div class="control-group">
								<label class="control-label"> Year Filter <span id="year-value" class="value-display" style="margin-left: 8px;"></span>
								</label>
								<div class="timeline-container">
									<div class="decade-markers">
										<span class="decade-marker" data-year="1960">1960s</span>
										<span class="decade-marker" data-year="1970">1970s</span>
										<span class="decade-marker" data-year="1980">1980s</span>
										<span class="decade-marker" data-year="1990">1990s</span>
										<span class="decade-marker" data-year="2000">2000s</span>
										<span class="decade-marker" data-year="2010">2010s</span>
										<span class="decade-marker" data-year="2020">2020s</span>
									</div>
									<input type="range" id="year-slider" class="slider" />
								</div>
							</div>
							<div class="control-group">
								<div class="control-label">View Mode:</div>
								<div class="view-mode-selector">
									<button class="view-mode-btn" data-mode="chronological">Chronological</button>
									<button class="view-mode-btn" data-mode="density">Density</button>
									<button class="view-mode-btn" data-mode="height">Height</button>
								</div>
								<div class="control-label" style="margin-top: 12px;">3D Remote Controls</div>
								<div class="remote-controls">
									<button id="tilt-up" title="Tilt Up">
										<svg viewBox="0 0 24 24">
											<path d="M12 4l-8 8h16z" />
										</svg>
									</button>
									<button id="rotate-left" title="Rotate Left">
										<svg viewBox="0 0 24 24" style="transform:rotate(-90deg)">
											<path d="M12 4l-8 8h16z" />
										</svg>
									</button>
									<button id="reset-view" title="Reset View">
										<svg viewBox="0 0 24 24">
											<path d="M12 4V1L8 5l4 4V6c3.3 0 6 2.7 6 6s-2.7 6-6 6-6-2.7-6-6h-2c0 4.4 3.6 8 8 8s8-3.6 8-8-3.6-8-8-8z" />
										</svg>
									</button>
									<button id="rotate-right" title="Rotate Right">
										<svg viewBox="0 0 24 24" style="transform:rotate(90deg)">
											<path d="M12 4l-8 8h16z" />
										</svg>
									</button>
									<button id="tilt-down" title="Tilt Down">
										<svg viewBox="0 0 24 24" style="transform:rotate(180deg)">
											<path d="M12 4l-8 8h16z" />
										</svg>
									</button>
								</div>
							</div>
							<div class="control-group">
								<div class="building-info-panel">
									<h3><i class="fas fa-info-circle"></i> Building Information</h3>
									<div id="building-info" class="building-info-content">
										<div class="no-building-selected"> Hover over a building to see details </div>
									</div>
								</div>
							</div>
						</div>
						<!-- Legend -->
						<div class="legend" id="legend">
							<div class="legend-header">
								<h3>Legend</h3>
								<div class="toggle-legend" id="toggle-legend">
									<svg width="12" height="12" viewBox="0 0 24 24" fill="#444">
										<path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path>
									</svg>
								</div>
							</div>
							<div class="legend-content">
								<div class="legend-item">
									<div class="legend-color" style="background:#cccccc"></div>Buildings
								</div>
								<div class="legend-item">
									<div class="legend-color" style="background:#ffeb3b"></div>Hover Highlight
								</div>
								<div id="mode-legend" style="display:none;">
								</div>
							</div>
			</section>
			<!-- Population -->
			<section id="population" class="bg-white p-8 rounded shadow">
				<h2 class="text-2xl font-bold mb-6 text-red-600 border-b pb-2">Population Dashboard</h2>
				<!-- Controls -->
				<div class="flex flex-wrap justify-between items-center mb-6">
					<div class="flex items-center space-x-2">
						<label class="font-medium">From:</label>
						<select id="startYear" class="border px-2 py-1 rounded"></select>
						<label class="font-medium">To:</label>
						<select id="endYear" class="border px-2 py-1 rounded"></select>
						<button id="updateBtn" class="ml-4 bg-red-600 text-white px-4 py-1 rounded">Update</button>
					</div>
				</div>
				<!-- Trend chart -->
				<div class="bg-gray-50 p-4 rounded shadow mb-6">
					<h3 class="text-lg font-semibold mb-2">Population Trend</h3>
					<div class="w-full max-w-3xl mx-auto mb-6">
						<canvas id="populationTrendChart" class="w-full h-64"></canvas>
					</div>
					<!-- KPI cards -->
					<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
						<div class="bg-gray-50 p-4 rounded shadow">
							<h3 class="text-lg font-semibold mb-2">Total Population</h3>
							<div id="currentPopulation" class="text-2xl font-bold text-red-600">â€“</div>
							<div id="populationChange" class="mt-1 text-sm">â€“</div>
						</div>
						<div class="bg-gray-50 p-4 rounded shadow">
							<h3 class="text-lg font-semibold mb-2">Median Age</h3>
							<div id="currentMedianAge" class="text-2xl font-bold text-red-600">â€“</div>
							<div id="medianAgeChange" class="mt-1 text-sm">â€“</div>
						</div>
						<div class="bg-gray-50 p-4 rounded shadow">
							<h3 class="text-lg font-semibold mb-2">Support Ratio</h3>
							<div id="currentSupportRatio" class="text-2xl font-bold text-red-600">â€“</div>
							<div id="supportRatioChange" class="mt-1 text-sm">â€“</div>
						</div>
					</div>
					<!-- Composition pie -->
					<div>
						<label>
							<input type="checkbox" id="toggleComposition" checked> Show Population Composition </label>
					</div>
					<!-- Container for composition charts -->
					<div id="compositionContainer" style="display: block;">
						<div style="display: flex; justify-content: space-around; width: 100%; margin-top: 20px;">
							<!-- Left chart (Start Year) -->
							<div style="width: 45%;">
								<h3 id="startYearTitle" style="text-align: center;">Population Composition</h3>
								<div style="height: 300px; position: relative;">
									<canvas id="startYearChart"></canvas>
								</div>
							</div>
							<!-- Right chart (End Year) -->
							<div style="width: 45%;">
								<h3 id="endYearTitle" style="text-align: center;">Population Composition</h3>
								<div style="height: 300px; position: relative;">
									<canvas id="endYearChart"></canvas>
								</div>
							</div>
						</div>
					</div>
	</main>
	<!-- FOOTER -->
	<footer class="bg-gray-800 text-white py-8">
		<div class="container mx-auto px-4">
			<div class="mb-6 text-center">
				<h3 class="text-xl font-bold mb-2">SG60: Singapore's Development Journey</h3>
				<p class="text-gray-400">Exploring 60 years of transformation through data visualization</p>
			</div>
			<div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-4xl mx-auto mb-6">
				<div class="data-source-card">
					<h4 class="text-lg font-semibold flex items-center mb-2">
						<i class="fas fa-map-location-dot mr-2 text-red-300"></i> Geographic Data
					</h4>
					<p class="text-sm text-gray-300 mb-2"><span class="font-medium">Source:</span> URA (Urban Redevelopment Authority)</p>
					<p class="text-sm text-gray-300 mb-2"><span class="font-medium">Dataset:</span> Master Plan 2019 Region Boundary (No Sea) (GEOJSON)</p>
					<a href="https://data.gov.sg/datasets?query=boudary&resultId=d_bf4d24df9129d5a8ff8cf82e20959ee0&page=1" class="data-source-link text-sm flex items-center">
						<i class="fas fa-external-link-alt mr-1"></i> View on data.gov.sg </a>
				</div>
				<div class="data-source-card">
					<h4 class="text-lg font-semibold flex items-center mb-2">
						<i class="fas fa-users mr-2 text-blue-300"></i> Population Data
					</h4>
					<p class="text-sm text-gray-300 mb-2"><span class="font-medium">Source:</span> SINGSTAT (Singapore Department of Statistics)</p>
					<p class="text-sm text-gray-300 mb-2"><span class="font-medium">Dataset:</span> Indicators On Population, Annual</p>
					<a href="https://data.gov.sg/datasets?query=Indicators+On+Population&resultId=d_3d227e5d9fdec73f3bcadce671c333a6&page=1" class="data-source-link text-sm flex items-center">
						<i class="fas fa-external-link-alt mr-1"></i> View on data.gov.sg </a>
				</div>
				<div class="data-source-card">
					<h4 class="text-lg font-semibold flex items-center mb-2">
						<i class="fas fa-building mr-2 text-green-300"></i> Housing Data (Property)
					</h4>
					<p class="text-sm text-gray-300 mb-2"><span class="font-medium">Source:</span> HDB (Housing & Development Board)</p>
					<p class="text-sm text-gray-300 mb-2"><span class="font-medium">Dataset:</span> HDB Property Information</p>
					<a href="https://data.gov.sg/datasets?query=HDB&page=1&resultId=d_17f5382f26140b1fdae0ba2ef6239d2f" class="data-source-link text-sm flex items-center">
						<i class="fas fa-external-link-alt mr-1"></i> View on data.gov.sg </a>
				</div>
				<div class="data-source-card">
					<h4 class="text-lg font-semibold flex items-center mb-2">
						<i class="fas fa-city mr-2 text-yellow-300"></i> Building Data
					</h4>
					<p class="text-sm text-gray-300 mb-2"><span class="font-medium">Source:</span> HDB (Housing & Development Board)</p>
					<p class="text-sm text-gray-300 mb-2"><span class="font-medium">Dataset:</span> HDB Existing Building</p>
					<a href="https://data.gov.sg/datasets?query=HDB&page=1&resultId=d_16b157c52ed637edd6ba1232e026258d" class="data-source-link text-sm flex items-center">
						<i class="fas fa-external-link-alt mr-1"></i> View on data.gov.sg </a>
				</div>
			</div>
			<div class="flex flex-col md:flex-row justify-center items-center text-center pt-4 border-t border-gray-700">
				<div class="mb-4 md:mb-0">
					<p class="text-sm text-gray-400">SG60: Visualizing Singapore's 60 Years of Development</p>
					<p>Baorong Li & Ravi. Prudhvi Naga Sai Kumar</p>
					<p class="text-sm text-gray-400">Link to Project idea</p>
					<a href="https://prudhvinsk.github.io/SG-60-Project-Idea/" target="_blank">SG 60 Project Idea</a>
				</div>
			</div>
		</div>
	</footer>
	<!-- NAVIGATION & 3D MAP & POPULATION INITIALIZATION SCRIPT -->
	<script>
		document.addEventListener('DOMContentLoaded', () => {
		  const nav = document.getElementById('main-nav');
		  const mainContent = document.getElementById('main-content');
		  const navItems = document.querySelectorAll('.nav-item');
		  
		  // Store the original position of the navbar
		  const navPosition = nav.getBoundingClientRect().top + window.scrollY;
		  
		  // Function to handle scroll behavior
		  function handleScroll() {
		    if (window.scrollY >= navPosition) {
		      // When scrolled past the original position, fix the navbar
		      nav.classList.add('nav-fixed');
		      mainContent.classList.add('content-padding');
		    } else {
		      // When scrolled back up, remove the fixed positioning
		      nav.classList.remove('nav-fixed');
		      mainContent.classList.remove('content-padding');
		    }
		    
		    // Update active nav item based on scroll position
		    const scrollPosition = window.scrollY + 100;
		    const sections = document.querySelectorAll('section');
		    
		    sections.forEach(section => {
		      const sectionTop = section.offsetTop;
		      const sectionHeight = section.offsetHeight;
		      
		      if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
		        const id = section.getAttribute('id');
		        navItems.forEach(item => {
		          item.classList.remove('active');
		          if (item.getAttribute('href') === `#${id}`) {
		            item.classList.add('active');
		          }
		        });
		      }
		    });
		  }
		  
		  // Listen for scroll events
		  window.addEventListener('scroll', handleScroll);
		  
		  // Add click event for navigation
		  navItems.forEach(item => {
		    item.addEventListener('click', e => {
		      e.preventDefault();
		      navItems.forEach(i => i.classList.remove('active'));
		      item.classList.add('active');
		      
		      const targetId = item.getAttribute('href');
		      const target = document.querySelector(targetId);
		      
		      target.scrollIntoView({ 
		        behavior: 'smooth',
		        block: 'start'
		      });
		    });
		  });
		
		  // =====================
		  // 3D MAP INITIALIZATION
		  // =====================
		  
		  // Initial view constants
		  const initialCenter  = [103.8, 1.35];
		  const initialZoom    = 10;
		  const initialPitch   = 0;
		  const initialBearing = 0;
		  const pitchStep      = 15;
		  const bearingStep    = 45;
		  let currentPitch     = initialPitch;
		  let currentViewMode  = null;
		  let hdbData = null;
		  let totalBuildings = 0;
		  let currentViewBuildings = 0;
		  let avgFloors = 0;
		  let latestYear = 0;
		  let hideTimeout = null;
		  let userManuallyToggled = false; // Track if user manually toggled panels
		
		  // Helper: decode HTML entities
		  function decodeEntities(str) {
		    const txt = document.createElement('textarea');
		    txt.innerHTML = str;
		    return txt.value;
		  }
		
		  // Helper: parse description from HTML
		  function parseDesc(descHtml) {
		    if (!descHtml) return { block: 'N/A', street: 'N/A' };
		    
		    try {
		      const decoded = decodeEntities(descHtml);
		      const tempDiv = document.createElement('div');
		      tempDiv.innerHTML = decoded;
		      
		      // Try to find block and street information
		      const rows = tempDiv.querySelectorAll('tr');
		      let block = 'N/A';
		      let street = 'N/A';
		      
		      rows.forEach(row => {
		        const header = row.querySelector('th')?.textContent.toLowerCase();
		        const value = row.querySelector('td')?.textContent;
		        
		        if (header && value) {
		          if (header.includes('blk') || header.includes('block')) {
		            block = value;
		          } else if (header.includes('street')) {
		            street = value;
		          }
		        }
		      });
		      
		      return { block, street };
		    } catch (err) {
		      console.error('Error parsing description:', err);
		      return { block: 'N/A', street: 'N/A' };
		    }
		  }
		
		  // Update statistics display
		  function updateStatistics(total, current, avgFloor, latest) {
		    document.getElementById('stat-total').textContent = total.toLocaleString();
		    document.getElementById('stat-current').textContent = current.toLocaleString();
		    document.getElementById('stat-avg-floor').textContent = avgFloor;
		    document.getElementById('stat-latest').textContent = latest;
		  }
		
		  // Initialize map as flat 2D Singapore-wide view
		  const map = new maplibregl.Map({
		    container: 'map',
		    style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
		    center: initialCenter,
		    zoom: initialZoom,
		    pitch: initialPitch,
		    bearing: initialBearing,
		    antialias: true
		  });
		
		  // Add compass only at top-right
		  map.addControl(
		    new maplibregl.NavigationControl({ showCompass: true, showZoom: false }),
		    'top-right'
		  );
		  // Add scale bar
		  map.addControl(new maplibregl.ScaleControl({ unit: 'metric' }), 'bottom-right');
		  
		  // Setup collapsible panels - FIXED TOGGLE FUNCTIONALITY
		  function setupPanelToggles() {
		    // Control panel toggle
		    const controlPanel = document.getElementById('control-panel');
		    const togglePanelBtn = document.getElementById('toggle-panel');
		    
		    if (togglePanelBtn) {
		      togglePanelBtn.addEventListener('click', function(e) {
		        e.stopPropagation(); // Prevent event bubbling
		        userManuallyToggled = true; // User manually toggled
		        controlPanel.classList.toggle('collapsed');
		        resetHideTimer();
		      });
		    }
		    
		    // Legend panel toggle
		    const legendPanel = document.getElementById('legend');
		    const toggleLegendBtn = document.getElementById('toggle-legend');
		    
		    if (toggleLegendBtn) {
		      toggleLegendBtn.addEventListener('click', function(e) {
		        e.stopPropagation(); // Prevent event bubbling
		        userManuallyToggled = true; // User manually toggled
		        legendPanel.classList.toggle('collapsed');
		        resetHideTimer();
		      });
		    }
		  }
		
		  map.on('load', async () => {
		    document.getElementById('map').addEventListener('wheel', e => e.stopPropagation());
		    document.getElementById('map').addEventListener('touchmove', e => e.stopPropagation());
	            userManuallyToggled = true;
		    
		    // Call the panel toggle setup function
		    setupPanelToggles();
		    
		    try {
		      // 1) Load Singapore boundary - Add error handling
		      try {
		        const sgBoundaryResponse = await fetch('https://raw.githubusercontent.com/carionb/Local/main/MasterPlan2019RegionBoundaryNoSeaGEOJSON.geojson');
		        if (!sgBoundaryResponse.ok) {
		          throw new Error(`Failed to load boundary: ${sgBoundaryResponse.status}`);
		        }
		        const sgBoundaryData = await sgBoundaryResponse.json();
		        
		        map.addSource('sg-boundary', {
		          type: 'geojson',
		          data: sgBoundaryData
		        });
		        
		        map.addLayer({
		          id: 'sg-boundary-line',
		          type: 'line',
		          source: 'sg-boundary',
		          paint: {
		            'line-color': '#0a0a0a',
		            'line-width': 1
		          }
		        });
		        console.log('Singapore boundary loaded successfully');
		      } catch (err) {
		        console.warn('Error loading Singapore boundary:', err);
		        // Continue anyway - this isn't critical for tooltips
		      }
		      
		      // 2) Load HDB GeoJSON with better error handling
		      try {
		        const resp = await fetch('https://raw.githubusercontent.com/carionb/Local/main/HDB_description_floor_year.geojson');
		      
		        if (!resp.ok) {
		          throw new Error(`Failed to load HDB data: ${resp.status}`);
		        }
		        hdbData = await resp.json();
		        console.log('HDB data loaded successfully');
		        
		        // Calculate statistics
		        totalBuildings = hdbData.features.length;
		        
		        const years = hdbData.features
		          .map(f => f.properties.YEAR || f.properties.year)
		          .filter(y => y && y >= 1950 && y <= 2024);
		        latestYear = Math.max(...years);
		        
		        const floors = hdbData.features
		          .map(f => f.properties.FLOOR || f.properties.floor || 1)
		          .filter(f => f);
		        avgFloors = Math.round(floors.reduce((sum, f) => sum + f, 0) / floors.length * 10) / 10;
		        
		        // Update statistics panel
		        updateStatistics(totalBuildings, totalBuildings, avgFloors, latestYear);
		        
		        map.addSource('hdb', {
		          type: 'geojson',
		          data: hdbData,
		          generateId: true
		        });
		        
		        // 3) Year slider setup
		        const minY = Math.min(...years), maxY = Math.max(...years);
		        const slider = document.getElementById('year-slider');
		        const label  = document.getElementById('year-value');
		        slider.min = minY; slider.max = maxY; slider.value = maxY;
		        label.textContent = maxY;
		      
		        // 4) Single extrusion layer with color expression for hover
		        map.addLayer({
		          id: 'hdb-3d',
		          type: 'fill-extrusion',
		          source: 'hdb',
		          paint: {
		            // Default to gray buildings
		            'fill-extrusion-color': [
		              'case',
		              ['boolean', ['feature-state','hover'], false],
		              '#ffeb3b',
		              '#cccccc'
		            ],
		            'fill-extrusion-height': ['*',
		              ['coalesce', ['get','FLOOR'], ['get','floor'], 1], 3
		            ],
		            'fill-extrusion-opacity': 0.85,
		            'fill-extrusion-vertical-gradient': true
		          }
		        });
		        
		        // Year filter function
		        function setYearFilter(year) {
		          map.setFilter('hdb-3d', [
		            '<=', ['coalesce',['get','YEAR'],['get','year'], 0], year
		          ]);
		          
		          // Update statistics for current view
		          const filteredFeatures = hdbData.features.filter(f => {
		            const buildingYear = f.properties.YEAR || f.properties.year || 0;
		            return buildingYear <= year;
		          });
		          
		          currentViewBuildings = filteredFeatures.length;
		          
		          const filteredFloors = filteredFeatures
		            .map(f => f.properties.FLOOR || f.properties.floor || 1);
		          const filteredAvgFloors = Math.round(filteredFloors.reduce((sum, f) => sum + f, 0) / filteredFloors.length * 10) / 10;
		          
		          updateStatistics(totalBuildings, currentViewBuildings, filteredAvgFloors, year);
		        }
		        
		        // 6) Year filter slider event
		        slider.oninput = e => {
		          const y = +e.target.value;
		          label.textContent = y;
		          setYearFilter(y);
		        };
		      
		        // Decade markers
		        const decadeMarkers = document.querySelectorAll('.decade-marker');
		        decadeMarkers.forEach(marker => {
		          marker.addEventListener('click', (e) => {
		            const year = parseInt(e.target.dataset.year) + 9; // End of decade
		            slider.value = year;
		            label.textContent = year;
		            setYearFilter(year);
		          });
		        });
		        
		      } catch (err) {
		        console.warn('Error loading HDB data:', err);
		        // Fallback to test data so tooltip can be demonstrated
		        console.log('Using fallback test HDB data');
		        hdbData = {
		          "type": "FeatureCollection",
		          "features": [
		            {
		              "type": "Feature",
		              "properties": {
		                "FLOOR": 12,
		                "YEAR": 1985,
		                "descriptio": "<table><tr><th>BLK_NO</th><td>123</td></tr><tr><th>STREET</th><td>Clementi Road</td></tr></table>"
		              },
		              "geometry": {
		                "type": "Polygon",
		                "coordinates": [[[103.8, 1.35], [103.81, 1.35], [103.81, 1.36], [103.8, 1.36], [103.8, 1.35]]]
		              }
		            },
		            {
		              "type": "Feature",
		              "properties": {
		                "floor": 25,
		                "year": 2005,
		                "descriptio": "<table><tr><th>Blk_No</th><td>456</td></tr><tr><th>Street</th><td>Orchard Road</td></tr></table>"
		              },
		              "geometry": {
		                "type": "Polygon",
		                "coordinates": [[[103.82, 1.37], [103.83, 1.37], [103.83, 1.38], [103.82, 1.38], [103.82, 1.37]]]
		              }
		            }
		          ]
		        };
		        
		        // Create fallback years array
		        const years = [1985, 2005];
		        latestYear = 2005;
		        totalBuildings = 2;
		        avgFloors = 18.5;
		        
		        map.addSource('hdb', {
		          type: 'geojson',
		          data: hdbData,
		          generateId: true
		        });
		        
		        // Add fallback slider
		        const minY = 1985, maxY = 2005;
		        const slider = document.getElementById('year-slider');
		        const label  = document.getElementById('year-value');
		        slider.min = minY; slider.max = maxY; slider.value = maxY;
		        label.textContent = maxY;
		        
		        // Add fallback layer
		        map.addLayer({
		          id: 'hdb-3d',
		          type: 'fill-extrusion',
		          source: 'hdb',
		          paint: {
		            'fill-extrusion-color': [
		              'case',
		              ['boolean', ['feature-state','hover'], false],
		              '#ffeb3b',
		              '#cccccc'
		            ],
		            'fill-extrusion-height': ['*',
		              ['coalesce', ['get','FLOOR'], ['get','floor'], 1], 3
		            ],
		            'fill-extrusion-opacity': 0.85,
		            'fill-extrusion-vertical-gradient': true
		          }
		        });
		        
		        // Update statistics for fallback
		        updateStatistics(totalBuildings, totalBuildings, avgFloors, latestYear);
		        
		        // Year filter function
		        function setYearFilter(year) {
		          map.setFilter('hdb-3d', [
		            '<=', ['coalesce',['get','YEAR'],['get','year'], 0], year
		          ]);
		          
		          const filteredFeatures = hdbData.features.filter(f => {
		            const buildingYear = f.properties.YEAR || f.properties.year || 0;
		            return buildingYear <= year;
		          });
		          
		          currentViewBuildings = filteredFeatures.length;
		          
		          const filteredFloors = filteredFeatures
		            .map(f => f.properties.FLOOR || f.properties.floor || 1);
		          const filteredAvgFloors = Math.round(filteredFloors.reduce((sum, f) => sum + f, 0) / filteredFloors.length * 10) / 10;
		          
		          updateStatistics(totalBuildings, currentViewBuildings, filteredAvgFloors, year);
		        }
		        
		        // Add fallback year filter
		        slider.oninput = e => {
		          const y = +e.target.value;
		          label.textContent = y;
		          setYearFilter(y);
		        };
		      }
		      
		      // Hover interaction with better error handling
		      let hoveredId = null;
		      const buildingInfo = document.getElementById('building-info');
		      
		      map.on('mousemove', 'hdb-3d', (e) => {
		        try {
		          if (e.features.length === 0) return;
		          
		          if (hoveredId !== null) {
		            map.setFeatureState({ source: 'hdb', id: hoveredId }, { hover: false });
		          }
		          
		          hoveredId = e.features[0].id;
		          map.setFeatureState({ source: 'hdb', id: hoveredId }, { hover: true });
		          
		          const p = e.features[0].properties;
		          
		          const desc = parseDesc(p.descriptio || p.description || '');
		          const year = p.YEAR || p.year || 'N/A';
		          const floors = p.FLOOR || p.floor || 'N/A';
		          
		          buildingInfo.innerHTML = `
		            <div class="building-info-row">
		              <div class="building-info-label">Block</div>
		              <div class="building-info-value">${desc.block}</div> 
		            </div>
		            <div class="building-info-row">
		              <div class="building-info-label">Street</div>
		              <div class="building-info-value">${desc.street}</div>
		            </div>
		            <div class="building-info-row">
		              <div class="building-info-label">Year</div>
		              <div class="building-info-value">${year}</div>
		            </div>
		            <div class="building-info-row">
		              <div class="building-info-label">Floors</div>
		              <div class="building-info-value">${floors}</div>
		            </div>
		          `;
		          
		        } catch (err) {
		          console.error('Error in mousemove handler:', err);
		          
		          buildingInfo.innerHTML = `
		            <div class="no-building-selected">
		              Information currently unavailable
		            </div>
		          `;
		        }
		      });
		      
		      map.on('mouseleave', 'hdb-3d', () => {
		        try {
		          if (hoveredId !== null) {
		            map.setFeatureState({ source: 'hdb', id: hoveredId }, { hover: false });
		          }
		          hoveredId = null;
		          buildingInfo.innerHTML = `
		            <div class="no-building-selected">
		              Hover over a building to see details
		            </div>
		          `;
		        } catch (err) {
		          console.error('Error in mouseleave handler:', err);
		        }
		      });
		      
		      // 7) Remote-control actions
		      function ease(opts){ map.easeTo(Object.assign({ duration:500 }, opts)); }
		      document.getElementById('tilt-up').onclick = () => {
		        currentPitch = Math.min(85, currentPitch + pitchStep);
		        ease({ pitch: currentPitch });
		        resetHideTimer();
		      };
		      document.getElementById('tilt-down').onclick = () => {
		        currentPitch = Math.max(0, currentPitch - pitchStep);
		        ease({ pitch: currentPitch });
		        resetHideTimer();
		      };
		      document.getElementById('reset-view').onclick = () => {
		        currentPitch = initialPitch;
		        
		        // Reset view mode buttons
		        const viewModeButtons = document.querySelectorAll('.view-mode-btn');
		        viewModeButtons.forEach(b => b.classList.remove('active'));
		        
		        // Reset building colors to original state
		        map.setPaintProperty('hdb-3d', 'fill-extrusion-color', [
		          'case',
		          ['boolean', ['feature-state','hover'], false],
		          '#ffeb3b',
		          '#cccccc' 
		        ]);
		        
		        // Reset legend display
		        const modeLegend = document.getElementById('mode-legend');
		        modeLegend.innerHTML = '';
		        modeLegend.style.display = 'none';
		        
		        // Reset camera position
		        ease({
		          center: initialCenter,
		          zoom: initialZoom,
		          pitch: initialPitch,
		          bearing: initialBearing,
		          duration: 1000
		        });
		        
		        // Reset timeline filter
		        const slider = document.getElementById('year-slider');
		        const label = document.getElementById('year-value');
		        slider.value = latestYear;
		        label.textContent = latestYear;
		        setYearFilter(latestYear);
		        
		        // Reset statistics display
		        updateStatistics(totalBuildings, totalBuildings, avgFloors, latestYear);
		        
		        // Ensure panels are expanded
		        document.getElementById('control-panel').classList.remove('collapsed');
		        document.getElementById('legend').classList.remove('collapsed');
		        userManuallyToggled = false; // Reset toggle state
		        resetHideTimer();
		      };
		      document.getElementById('rotate-right').onclick = () => {
		        ease({ bearing: map.getBearing() - bearingStep });
		        resetHideTimer();
		      };
		      document.getElementById('rotate-left').onclick = () => {
		        ease({ bearing: map.getBearing() + bearingStep });
		        resetHideTimer();
		      };
		      
		      // 8) View Mode Selector
		      const viewModeButtons = document.querySelectorAll('.view-mode-btn');
		      viewModeButtons.forEach(btn => {
		        btn.addEventListener('click', (e) => {
		          // Remove active class from all buttons
		          viewModeButtons.forEach(b => b.classList.remove('active'));
		          // Add active class to clicked button
		          e.target.classList.add('active');
		          
		          // Update view mode
		          const mode = e.target.dataset.mode;
		          updateViewMode(mode);
		          resetHideTimer();
		        });
		      });
		      
		      // Update view mode (chronological, density, height)
		      function updateViewMode(mode) {
		        currentViewMode = mode;
		        const modeLegend = document.getElementById('mode-legend');
		        
		        // Update building colors based on mode
		        if (mode === 'chronological') {
		          map.setPaintProperty('hdb-3d', 'fill-extrusion-color', [
  'case',
  ['boolean', ['feature-state','hover'], false],
  '#ffeb3b',
  ['interpolate', ['linear'],
    ['coalesce', ['get','YEAR'], ['get','year'], 1960],
    1960, '#00204d',
    1970, '#173b7d',
    1980, '#2e54a1',
    1990, '#507fc0',
    2000, '#7cb9dd',
    2010, '#abd9e9',
    2020, '#edf8eb'
  ]
]);
		          
		          // legend
		          modeLegend.innerHTML = `
  <div class="legend-item"><div class="legend-color" style="background:#00204d"></div>1960s</div>
  <div class="legend-item"><div class="legend-color" style="background:#173b7d"></div>1970s</div>
  <div class="legend-item"><div class="legend-color" style="background:#2e54a1"></div>1980s</div>
  <div class="legend-item"><div class="legend-color" style="background:#507fc0"></div>1990s</div>
  <div class="legend-item"><div class="legend-color" style="background:#7cb9dd"></div>2000s</div>
  <div class="legend-item"><div class="legend-color" style="background:#abd9e9"></div>2010s</div>
  <div class="legend-item"><div class="legend-color" style="background:#edf8eb"></div>2020s</div>
`;
modeLegend.style.display = 'block';
		        } 
		        else if (mode === 'density') {
		          // Use building proximity/density
		          map.setPaintProperty('hdb-3d', 'fill-extrusion-color', [
		            'case',
		            ['boolean', ['feature-state','hover'], false],
		            '#ffeb3b',
		            [
		              'interpolate',
		              ['linear'],
		              ['coalesce', ['get', 'FLOOR'], ['get', 'floor'], 1],
		              1, '#c5e1a5',  // Light green for low density
		              5, '#7cb342',  // Medium green
		              10, '#33691e', // Dark green for high density
		              20, '#1b5e20'  // Very dark green for very high density
		            ]
		          ]);
		          
		          // Update legend for density mode
		          modeLegend.innerHTML = `
		            <div class="legend-item">
		              <div class="legend-color" style="background:#c5e1a5"></div>Low Density
		            </div>
		            <div class="legend-item">
		              <div class="legend-color" style="background:#7cb342"></div>Medium Density
		            </div>
		            <div class="legend-item">
		              <div class="legend-color" style="background:#33691e"></div>High Density
		            </div>
		            <div class="legend-item">
		              <div class="legend-color" style="background:#1b5e20"></div>Very High Density
		            </div>
		          `;
		          modeLegend.style.display = 'block';
		        }
		        else if (mode === 'height') {
		          // Height-based coloring
		          map.setPaintProperty('hdb-3d', 'fill-extrusion-color', [
		            'case',
		            ['boolean', ['feature-state','hover'], false],
		            '#ffeb3b',
		            [
		              'interpolate',
		              ['linear'],
		              ['coalesce', ['get', 'FLOOR'], ['get', 'floor'], 1],
		              1,  '#e0f7fa',  // Light cyan for low
		              10, '#80deea',  // Medium cyan
		              20, '#26c6da',  // Cyan
		              30, '#0097a7',  // Dark cyan
		              40, '#006064'   // Very dark cyan
		            ]
		          ]);
		          
		          // Update legend for height mode
		          modeLegend.innerHTML = `
		            <div class="legend-item">
		              <div class="legend-color" style="background:#e0f7fa"></div>1-10 Floors
		            </div>
		            <div class="legend-item">
		              <div class="legend-color" style="background:#80deea"></div>10-20 Floors
		            </div>
		            <div class="legend-item">
		              <div class="legend-color" style="background:#26c6da"></div>20-30 Floors
		            </div>
		            <div class="legend-item">
		              <div class="legend-color" style="background:#0097a7"></div>30-40 Floors
		            </div>
		            <div class="legend-item">
		              <div class="legend-color" style="background:#006064"></div>40+ Floors
		            </div>
		          `;
		          modeLegend.style.display = 'block';
		        }
		        
		        // Toggle legend visibility
		        document.getElementById('legend').classList.remove('collapsed');
		      }
		      
		      // FIXED: Improved auto-hide function
		      function resetHideTimer() {
		        // Clear existing timer
		        clearTimeout(hideTimeout);
		        
		        // Set new timer (50 seconds)
		        hideTimeout = setTimeout(() => {
		          // Only hide panels if user didn't manually toggle them
		          if (!userManuallyToggled) {
		            const controlPanel = document.getElementById('control-panel');
		            const legend = document.getElementById('legend');
		            
		            if (controlPanel && !controlPanel.classList.contains('collapsed')) {
		              controlPanel.classList.add('collapsed');
		            }
		            if (legend && !legend.classList.contains('collapsed')) {
		              legend.classList.add('collapsed');
		            }
		          }
		        }, 50000); // 50 seconds
		      }
		
		      
		      // Setup user activity listeners
		      document.addEventListener('mousemove', resetHideTimer);
		      document.addEventListener('click', resetHideTimer);
		      document.addEventListener('keydown', resetHideTimer);
		      
		      // Start the auto-hide timer
		      resetHideTimer();
		      
		    } catch (err) {
		      console.error('General map error:', err);
		    }
		  });
		});
		
		// Population dashboard logic
		document.addEventListener('DOMContentLoaded', function() {
		var rawData, years;
		var trendChart = null;
		var startYearChart = null;
		var endYearChart = null;
		
		// 1. Load CSV
		fetch('https://raw.githubusercontent.com/carionb/Local/main/POPULATION.csv')
		    .then(function(r) { return r.text(); })
		    .then(function(text) {
		        var header = text.trim().split('\n')[0];
		        var lines = text.trim().split('\n').slice(1);
		        var cols = header.split(',').slice(1);
		        rawData = lines.map(function(line) {
		            var vals = line.split(',');
		            var obj = { series: vals[0] };
		            cols.forEach(function(col, i) {
		                obj[col] = vals[i+1] === 'na' ? null : +vals[i+1];
		            });
		            return obj;
		        });
		        years = cols.filter(function(c) { return /^\d+$/.test(c); })
		                   .map(function(y) { return +y; })
		                   .sort(function(a, b) { return a - b; });
		        initControls();
		        updateDashboard();
		    });
		
		// Helper function to get values from data
		function getVal(series, year) {
		    var row = rawData.find(function(r) { return r.series === series; });
		    return row ? row[year] : null;
		}
		
		// 2. Initialize selectors and toggle
		function initControls() {
		    var s = document.getElementById('startYear');
		    var e = document.getElementById('endYear');
		    var btn = document.getElementById('updateBtn');
		    var tog = document.getElementById('toggleComposition');
		
		    years.forEach(function(y) {
		        s.add(new Option(y, y));
		        e.add(new Option(y, y));
		    });
		    s.value = years[Math.max(0, years.length - 20)];
		    e.value = years[years.length - 1];
		    btn.onclick = updateDashboard;
		    tog.onchange = function() {
		        document.getElementById('compositionContainer').style.display = tog.checked ? 'block' : 'none';
		    };
		}
		
		// 3. Update all displays
		function updateDashboard() {
		    var startY = +document.getElementById('startYear').value;
		    var endY = +document.getElementById('endYear').value;
		    var span = years.filter(function(y) { return y >= startY && y <= endY; });
		
		    // 4. KPI cards
		    var startPop = getVal('Total Population (Number)', startY);
		    var endPop = getVal('Total Population (Number)', endY);
		    document.getElementById('currentPopulation').textContent = 
		        endPop != null ? endPop.toLocaleString() : 'â€“';
		    document.getElementById('populationChange').textContent = 
		        (startPop && endPop) ? 
		        ((endPop - startPop)/startPop*100).toFixed(1) + '%' : 'N/A';
		
		    var startAge = getVal('Median Age Of Resident Population (Years)', startY);
		    var endAge = getVal('Median Age Of Resident Population (Years)', endY);
		    document.getElementById('currentMedianAge').textContent = 
		        endAge != null ? endAge : 'â€“';
		    document.getElementById('medianAgeChange').textContent = 
		        (startAge && endAge) ? 
		        (endAge - startAge).toFixed(1) + ' yrs' : 'N/A';
		
		    var startSr = getVal('Old-Age Support Ratio: Residents Aged 15-64 Years Per Resident Aged 65 Years & Over (Number)', startY);
		    var endSr = getVal('Old-Age Support Ratio: Residents Aged 15-64 Years Per Resident Aged 65 Years & Over (Number)', endY);
		    document.getElementById('currentSupportRatio').textContent = 
		        endSr != null ? endSr : 'â€“';
		    document.getElementById('supportRatioChange').textContent = 
		        (startSr && endSr) ? 
		        (endSr - startSr).toFixed(1) : 'N/A';
		
		    // 5. Trend chart
		    var ctx1 = document.getElementById('populationTrendChart').getContext('2d');
		    if (trendChart) trendChart.destroy();
		    trendChart = new Chart(ctx1, {
		        type: 'line',
		        data: {
		            labels: span,
		            datasets: [{
		                label: 'Total Population',
		                data: span.map(function(y) { return getVal('Total Population (Number)', y); }),
		                borderColor: '#cc0000',
		                fill: false,
		                tension: 0.3
		            }]
		        },
		        options: { responsive: true, maintainAspectRatio: false }
		    });
		
		    // 6. Update composition charts
		    updateCompositionCharts(startY, endY);
		}
		
		function updateCompositionCharts(startY, endY) {
		    // Obtain 2D drawing contexts from canvas elements
		    var ctxStart = document.getElementById('startYearChart').getContext('2d');
		    var ctxEnd = document.getElementById('endYearChart').getContext('2d');
		
		    // If charts already exist, destroy them to avoid memory leaks
		    if (startYearChart) {
		        startYearChart.destroy();
		    }
		    if (endYearChart) {
		        endYearChart.destroy();
		    }
		
		    // Helper: fetch the three population values for a given year
		    function fetchCompositionData(year) {
		        return [
		            getVal('Singapore Citizen Population (Number)', year) || 0,
		            getVal('Permanent Resident Population (Number)', year) || 0,
		            getVal('Non-Resident Population (Number)', year) || 0
		        ];
		    }
		
		    // Helper: create a pie chart with title and data
		    function createPieChart(ctx, data, title) {
		        return new Chart(ctx, {
		            type: 'pie',
		            data: {
		                labels: ['Citizens', 'PRs', 'Non-Residents'],
		                datasets: [{
		                    data: data,
		                    backgroundColor: ['#2ecc71', '#f39c12', '#e74c3c']
		                }]
		            },
		            options: {
		                responsive: true,
		                maintainAspectRatio: false,
		                plugins: {
		                    title: {
		                        display: true,
		                        text: title
		                    }
		                }
		            }
		        });
		    }
		
		    // Build and store the new chart instances
		    startYearChart = createPieChart(
		        ctxStart,
		        fetchCompositionData(startY),
		        startY + ' Composition'
		    );
		
		    endYearChart = createPieChart(
		        ctxEnd,
		        fetchCompositionData(endY),
		        endY + ' Composition'
		    );
		}
		});
		
	</script>
</body>
</html>
