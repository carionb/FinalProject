<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Final Project - SG60: Visualizing Singapore's 60 Years of Development</title>
	<!-- Tailwind CSS -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
	<!-- D3.js -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js" defer></script>
	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<!-- MapLibre for 3D Map -->
	<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" />
	<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
	<!-- Chart.js â€” load *before* your code, no defer -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
	<style>
		/* Reset and basic */
		* { margin: 0; padding: 0; box-sizing: border-box; }
		html, body { height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
		body { background: #f9f9f9; color: #333; }
		
		/* Navigation styling */
		nav {
		  background: white;
		  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		  width: 100%;
		  z-index: 1000;
		}
		
		.nav-fixed {
		  position: fixed;
		  top: 0;
		}
		
		.nav-item { 
		  cursor: pointer; 
		  padding: 0.75rem 1.25rem;
		  transition: all 0.3s ease;
		  position: relative;
		  font-weight: 500;
		}
		
		.nav-item:hover {
		  color: #e53e3e;
		}
		
		.nav-item.active { 
		  color: #e53e3e; 
		  font-weight: 600; 
		}
		
		.nav-item.active:after {
		  content: '';
		  position: absolute;
		  bottom: 0;
		  left: 0;
		  width: 100%;
		  height: 3px;
		  background-color: #e53e3e;
		}
		
		/* Content area padding */
		.content-padding {
		  padding-top: 60px;
		}
		
		/* Section styling */
		section { 
		  scroll-margin-top: 70px;
		  padding: 2rem;
		  background: white;
		  border-radius: 8px;
		  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
		  margin-bottom: 2rem;
		}
		
		/* Module placeholder styling */
		.module-placeholder {
		  border: 2px dashed #cbd5e0;
		  border-radius: 6px;
		  padding: 2rem;
		  text-align: center;
		  background-color: #f7fafc;
		}
		
		/* Header animation */
		@keyframes gradientAnimation {
		  0% {background-position: 0% 50%}
		  50% {background-position: 100% 50%}
		  100% {background-position: 0% 50%}
		}
		
		.animated-header {
		  background: linear-gradient(90deg, #c53030, #e53e3e, #f56565);
		  background-size: 200% 200%;
		  animation: gradientAnimation 8s ease infinite;
		}
		
		/* Hover effects */
		.hover-effect:hover {
		  transform: translateY(-3px);
		  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
		}
		
		/* Data source cards */
		.data-source-card {
		  background-color: rgba(255, 255, 255, 0.1);
		  border-radius: 6px;
		  padding: 1rem;
		  transition: all 0.3s ease;
		}
		
		.data-source-card:hover {
		  background-color: rgba(255, 255, 255, 0.15);
		  transform: translateY(-2px);
		}
		
		.data-source-link {
		  color: #f0b3b3;
		  text-decoration: none;
		  transition: color 0.2s ease;
		}
		
		.data-source-link:hover {
		  color: #ffffff;
		  text-decoration: underline;
		}
		
		/* 3D Map Styles */
		#map {
		  height: 500px;
		  width: 100%;
		  position: relative;
		  z-index: 1;
		}
		
		/* Control Panel */
		.control-panel {
		  position: absolute;
		  top: 20px;
		  left: 20px;
		  background: rgba(255,255,255,0.9);
		  padding: 16px;
		  border-radius: 12px;
		  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
		  z-index: 2;
		  min-width: 260px;
		}
		
		.control-group {
		  margin-bottom: 16px;
		}
		
		.control-label {
		  display: block;
		  margin-bottom: 8px;
		  font-size: 15px;
		  color: #444;
		  font-weight: 600;
		}
		
		.slider {
		  width: 100%;
		}
		
		.value-display {
		  float: right;
		  font-weight: 500;
		  color: #333;
		}
		
		/* Remote-Style Controls */
		.remote-controls {
		  display: grid;
		  grid-template:
		    "up    up    up"      40px
		    "left reset right"    40px
		    "down  down  down"    40px
		    / 60px  60px  60px;
		  gap: 8px;
		  justify-items: center;
		}
		
		.remote-controls button {
		  border: none;
		  border-radius: 8px;
		  background: linear-gradient(135deg,#4a90e2,#357abd);
		  cursor: pointer;
		  width: 100%;
		  height: 100%;
		  display: flex;
		  align-items: center;
		  justify-content: center;
		  transition: background .2s,transform .2s;
		}
		
		.remote-controls button:hover {
		  background: linear-gradient(135deg,#357abd,#2a5a8f);
		  transform: scale(1.1);
		}
		
		#tilt-up     { grid-area: up; }
		#reset-view  { grid-area: reset; }
		#tilt-down   { grid-area: down; }
		#rotate-left { grid-area: left; }
		#rotate-right{ grid-area: right; }
		
		.remote-controls svg {
		  width: 16px;
		  height: 16px;
		  fill: rgba(255,255,255,0.9);
		}
		
		/* Legend */
		.legend {
		  position: absolute;
		  bottom: 30px;
		  left: 20px;
		  background: rgba(255,255,255,0.9);
		  padding: 12px;
		  border-radius: 8px;
		  font-size: 13px;
		  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
		  z-index: 2;
		}
		
		.legend-item {
		  display: flex;
		  align-items: center;
		  margin-bottom: 6px;
		}
		
		.legend-color {
		  width: 16px;
		  height: 16px;
		  margin-right: 8px;
		  border-radius: 3px;
		}
		
		 /* info panel */
		  .building-info-panel {
		margin-top: 16px;
		padding-top: 16px;
		border-top: 1px solid #e2e8f0;
		  }
		
		  .building-info-content {
		background: #f8fafc;
		border-radius: 6px;
		padding: 12px;
		border: 1px solid #e2e8f0;
		font-size: 13px;
		min-height: 100px;
		  }
		
		  .building-info-row {
		display: flex;
		margin-bottom: 6px;
		  }
		
		  .building-info-label {
		font-weight: 500;
		width: 60px;
		color: #4a5568;
		  }
		
		  .building-info-value {
		flex-grow: 1;
		color: #1a202c;
		  }
		
		  .no-building-selected {
		color: #718096;
		font-style: italic;
		text-align: center;
		padding: 8px 0;
		  }
		
	</style>
</head>
<body class="flex flex-col min-h-screen">
	<!-- HEADER -->
	<header class="animated-header text-white py-8 text-center">
		<div class="container mx-auto px-4">
			<h1 class="text-4xl font-bold mb-2">SG60: Visualizing Singapore's Development</h1>
			<p class="text-xl">Exploring Singapore's remarkable transformation since 1965</p>
		</div>
	</header>
	<!-- NAVIGATION -->
	<nav id="main-nav">
		<div class="container mx-auto">
			<ul class="flex justify-center space-x-2 md:space-x-8">
				<li><a href="#overview" class="nav-item active flex items-center"><i class="fas fa-home mr-2"></i> Overview</a></li>
				<li><a href="#housing" class="nav-item flex items-center"><i class="fas fa-building mr-2"></i> Housing</a></li>
				<li><a href="#map3d" class="nav-item flex items-center"><i class="fas fa-map-marked-alt mr-2"></i> 3D Map</a></li>
				<li><a href="#population" class="nav-item flex items-center"><i class="fas fa-users mr-2"></i> Population</a></li>
			</ul>
		</div>
	</nav>
	<!-- MAIN CONTENT -->
	<main id="main-content" class="flex-grow container mx-auto py-8 px-4">
		<div class="max-w-5xl mx-auto space-y-12">
			<!-- Overview -->
			<section id="overview" class="transition-all duration-300 hover-effect">
				<h2 class="text-2xl font-bold mb-6 text-red-600 border-b pb-2">Overview</h2>
				<div class="module-placeholder">
					<h3 class="text-xl font-medium text-gray-700 mb-4">Overview Module</h3>
					<p class="text-gray-600 mb-2">Paste your Overview module code here.</p>
					<p class="text-sm text-gray-500">Replace this placeholder with your content.</p>
				</div>
			</section>
			<!-- Housing Development -->
			<section id="housing" class="transition-all duration-300 hover-effect">
				<h2 class="text-2xl font-bold mb-6 text-red-600 border-b pb-2">Housing Development</h2>
				<div class="module-placeholder">
					<h3 class="text-xl font-medium text-gray-700 mb-4">Housing Development Module</h3>
					<p class="text-gray-600 mb-2">Paste your Housing Development module code here.</p>
					<p class="text-sm text-gray-500">Replace this placeholder with your content including charts, graphs, and analysis.</p>
				</div>
			</section>
			<!-- 3D Housing Map -->
			<section id="map3d" class="transition-all duration-300 hover-effect">
				<h2 class="text-2xl font-bold mb-6 text-red-600 border-b pb-2">3D Housing Map</h2>
				<p class="mb-4">Explore Singapore's HDB buildings in an interactive 3D view. Use the controls to navigate and filter by construction year.</p>
				<div class="relative" style="height: 600px;">
					<!-- Map Container -->
					<div id="map-container" class="relative" style="height: 600px;">
						<div id="map" style="height: 100%; width: 100%;"></div>
						<!-- Control Panel -->
						<div class="control-panel">
							<div class="control-group">
								<label class="control-label"> Year Filter <span id="year-value" class="value-display"></span>
								</label>
								<input type="range" id="year-slider" class="slider" />
							</div>
							<div class="control-group">
								<div class="control-label">3D Remote Controls</div>
								<div class="remote-controls">
									<button id="tilt-up" title="Tilt Up">
										<svg viewBox="0 0 24 24">
											<path d="M12 4l-8 8h16z" />
										</svg>
									</button>
									<button id="rotate-left" title="Rotate Left">
										<svg viewBox="0 0 24 24" style="transform:rotate(-90deg)">
											<path d="M12 4l-8 8h16z" />
										</svg>
									</button>
									<button id="reset-view" title="Reset View">
										<svg viewBox="0 0 24 24">
											<path d="M12 4V1L8 5l4 4V6c3.3 0 6 2.7 6 6s-2.7 6-6 6-6-2.7-6-6h-2c0 4.4 3.6 8 8 8s8-3.6 8-8-3.6-8-8-8z" />
										</svg>
									</button>
									<button id="rotate-right" title="Rotate Right">
										<svg viewBox="0 0 24 24" style="transform:rotate(90deg)">
											<path d="M12 4l-8 8h16z" />
										</svg>
									</button>
									<button id="tilt-down" title="Tilt Down">
										<svg viewBox="0 0 24 24" style="transform:rotate(180deg)">
											<path d="M12 4l-8 8h16z" />
										</svg>
									</button>
								</div>
							</div>
							<div class="building-info-panel">
								<h3><i class="fas fa-info-circle"></i> Building Information</h3>
								<div id="building-info" class="building-info-content">
									<div class="no-building-selected"> Hover over a building to see details </div>
								</div>
							</div>
						</div>
					</div>
					<!-- Legend -->
					<div class="legend">
						<div class="legend-item">
							<div class="legend-color" style="background:#cccccc"></div>Buildings
						</div>
						<div class="legend-item">
							<div class="legend-color" style="background:#ffeb3b"></div>Hover Highlight
						</div>
					</div>
				</div>
			</section>
			<!-- Population -->
			<section id="population" class="bg-white p-8 rounded shadow">
				<h2 class="text-2xl font-semibold text-red-600 mb-6 text-center">Population Dashboard</h2>
				<!-- Controls -->
				<div class="flex flex-wrap justify-between items-center mb-6">
					<div class="flex items-center space-x-2">
						<label class="font-medium">From:</label>
						<select id="startYear" class="border px-2 py-1 rounded"></select>
						<label class="font-medium">To:</label>
						<select id="endYear" class="border px-2 py-1 rounded"></select>
						<button id="updateBtn" class="ml-4 bg-red-600 text-white px-4 py-1 rounded">Update</button>
					</div>
				</div>
				<!-- Trend chart -->
				<div class="bg-gray-50 p-4 rounded shadow mb-6">
					<h3 class="text-lg font-semibold mb-2">Population Trend</h3>
					<div class="w-full max-w-3xl mx-auto mb-6">
						<canvas id="populationTrendChart" class="w-full h-64"></canvas>
					</div>
					<!-- KPI cards -->
					<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
						<div class="bg-gray-50 p-4 rounded shadow">
							<h3 class="text-lg font-semibold mb-2">Total Population</h3>
							<div id="currentPopulation" class="text-2xl font-bold text-red-600">â€“</div>
							<div id="populationChange" class="mt-1 text-sm">â€“</div>
						</div>
						<div class="bg-gray-50 p-4 rounded shadow">
							<h3 class="text-lg font-semibold mb-2">Median Age</h3>
							<div id="currentMedianAge" class="text-2xl font-bold text-red-600">â€“</div>
							<div id="medianAgeChange" class="mt-1 text-sm">â€“</div>
						</div>
						<div class="bg-gray-50 p-4 rounded shadow">
							<h3 class="text-lg font-semibold mb-2">Support Ratio</h3>
							<div id="currentSupportRatio" class="text-2xl font-bold text-red-600">â€“</div>
							<div id="supportRatioChange" class="mt-1 text-sm">â€“</div>
						</div>
					</div>
					<!-- Composition pie -->
					<div>
						<label>
							<input type="checkbox" id="toggleComposition" checked> Show Population Composition </label>
					</div>
					<!-- Container for composition charts -->
					<div id="compositionContainer" style="display: block;">
						<div style="display: flex; justify-content: space-around; width: 100%; margin-top: 20px;">
							<!-- Left chart (Start Year) -->
							<div style="width: 45%;">
								<h3 id="startYearTitle" style="text-align: center;">Population Composition</h3>
								<div style="height: 300px; position: relative;">
									<canvas id="startYearChart"></canvas>
								</div>
							</div>
							<!-- Right chart (End Year) -->
							<div style="width: 45%;">
								<h3 id="endYearTitle" style="text-align: center;">Population Composition</h3>
								<div style="height: 300px; position: relative;">
									<canvas id="endYearChart"></canvas>
								</div>
							</div>
						</div>
					</div>
	</main>
	<!-- FOOTER -->
	<footer class="bg-gray-800 text-white py-8">
		<div class="container mx-auto px-4">
			<div class="mb-6 text-center">
				<h3 class="text-xl font-bold mb-2">SG60: Singapore's Development Journey</h3>
				<p class="text-gray-400">Exploring 60 years of transformation through data visualization</p>
			</div>
			<div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-4xl mx-auto mb-6">
				<div class="data-source-card">
					<h4 class="text-lg font-semibold flex items-center mb-2">
						<i class="fas fa-map-location-dot mr-2 text-red-300"></i> Geographic Data
					</h4>
					<p class="text-sm text-gray-300 mb-2"><span class="font-medium">Source:</span> URA (Urban Redevelopment Authority)</p>
					<p class="text-sm text-gray-300 mb-2"><span class="font-medium">Dataset:</span> Master Plan 2019 Region Boundary (No Sea) (GEOJSON)</p>
					<a href="https://data.gov.sg/datasets?query=boudary&resultId=d_bf4d24df9129d5a8ff8cf82e20959ee0&page=1" class="data-source-link text-sm flex items-center">
						<i class="fas fa-external-link-alt mr-1"></i> View on data.gov.sg </a>
				</div>
				<div class="data-source-card">
					<h4 class="text-lg font-semibold flex items-center mb-2">
						<i class="fas fa-users mr-2 text-blue-300"></i> Population Data
					</h4>
					<p class="text-sm text-gray-300 mb-2"><span class="font-medium">Source:</span> SINGSTAT (Singapore Department of Statistics)</p>
					<p class="text-sm text-gray-300 mb-2"><span class="font-medium">Dataset:</span> Indicators On Population, Annual</p>
					<a href="https://data.gov.sg/datasets?query=Indicators+On+Population&resultId=d_3d227e5d9fdec73f3bcadce671c333a6&page=1" class="data-source-link text-sm flex items-center">
						<i class="fas fa-external-link-alt mr-1"></i> View on data.gov.sg </a>
				</div>
				<div class="data-source-card">
					<h4 class="text-lg font-semibold flex items-center mb-2">
						<i class="fas fa-building mr-2 text-green-300"></i> Housing Data (Property)
					</h4>
					<p class="text-sm text-gray-300 mb-2"><span class="font-medium">Source:</span> HDB (Housing & Development Board)</p>
					<p class="text-sm text-gray-300 mb-2"><span class="font-medium">Dataset:</span> HDB Property Information</p>
					<a href="https://data.gov.sg/datasets?query=HDB&page=1&resultId=d_17f5382f26140b1fdae0ba2ef6239d2f" class="data-source-link text-sm flex items-center">
						<i class="fas fa-external-link-alt mr-1"></i> View on data.gov.sg </a>
				</div>
				<div class="data-source-card">
					<h4 class="text-lg font-semibold flex items-center mb-2">
						<i class="fas fa-city mr-2 text-yellow-300"></i> Building Data
					</h4>
					<p class="text-sm text-gray-300 mb-2"><span class="font-medium">Source:</span> HDB (Housing & Development Board)</p>
					<p class="text-sm text-gray-300 mb-2"><span class="font-medium">Dataset:</span> HDB Existing Building</p>
					<a href="https://data.gov.sg/datasets?query=HDB&page=1&resultId=d_16b157c52ed637edd6ba1232e026258d" class="data-source-link text-sm flex items-center">
						<i class="fas fa-external-link-alt mr-1"></i> View on data.gov.sg </a>
				</div>
			</div>
			<div class="flex flex-col md:flex-row justify-between items-center pt-4 border-t border-gray-700">
				<div class="mb-4 md:mb-0">
					<p class="text-sm text-gray-400">SG60: Visualizing Singapore's 60 Years of Development</p>
					<p>Baorong Li & Ravi. Prudhvi Naga Sai Kumar</p>
				</div>
			</div>
		</div>
	</footer>
	<!-- NAVIGATION & 3D MAP INITIALIZATION SCRIPT -->
	<script>
		document.addEventListener('DOMContentLoaded', () => {
		  const nav = document.getElementById('main-nav');
		  const mainContent = document.getElementById('main-content');
		  const navItems = document.querySelectorAll('.nav-item');
		  
		  // Store the original position of the navbar
		  const navPosition = nav.getBoundingClientRect().top + window.scrollY;
		  
		  // Function to handle scroll behavior
		  function handleScroll() {
		    if (window.scrollY >= navPosition) {
		      // When scrolled past the original position, fix the navbar
		      nav.classList.add('nav-fixed');
		      mainContent.classList.add('content-padding');
		    } else {
		      // When scrolled back up, remove the fixed positioning
		      nav.classList.remove('nav-fixed');
		      mainContent.classList.remove('content-padding');
		    }
		    
		    // Update active nav item based on scroll position
		    const scrollPosition = window.scrollY + 100;
		    const sections = document.querySelectorAll('section');
		    
		    sections.forEach(section => {
		      const sectionTop = section.offsetTop;
		      const sectionHeight = section.offsetHeight;
		      
		      if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
		        const id = section.getAttribute('id');
		        navItems.forEach(item => {
		          item.classList.remove('active');
		          if (item.getAttribute('href') === `#${id}`) {
		            item.classList.add('active');
		          }
		        });
		      }
		    });
		  }
		  
		  // Listen for scroll events
		  window.addEventListener('scroll', handleScroll);
		  
		  // Add click event for navigation
		  navItems.forEach(item => {
		    item.addEventListener('click', e => {
		      e.preventDefault();
		      navItems.forEach(i => i.classList.remove('active'));
		      item.classList.add('active');
		      
		      const targetId = item.getAttribute('href');
		      const target = document.querySelector(targetId);
		      
		      target.scrollIntoView({ 
		        behavior: 'smooth',
		        block: 'start'
		      });
		    });
		  });
		
		  // =====================
		  // 3D MAP INITIALIZATION
		  // =====================
		  
		  // Initial view constants
		  const initialCenter = [103.8, 1.35];
		  const initialZoom = 10;
		  const initialPitch = 0;
		  const initialBearing = 0;
		  const pitchStep = 15;
		  const bearingStep = 45;
		  let currentPitch = initialPitch;
		
		  // Helper: decode HTML entities
		  function decodeEntities(str) {
		    const txt = document.createElement('textarea');
		    txt.innerHTML = str;
		    return txt.value;
		  }
		
		  // Initialize map as flat 2D Singapore-wide view
		  const map = new maplibregl.Map({
		    container: 'map',
		    style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
		    center: initialCenter,
		    zoom: initialZoom,
		    pitch: initialPitch,
		    bearing: initialBearing,
		    antialias: true
		  });
		
		  // Add compass only at top-right
		  map.addControl(
		    new maplibregl.NavigationControl({ showCompass: true, showZoom: false }),
		    'top-right'
		  );
		  // Add scale bar
		  map.addControl(new maplibregl.ScaleControl({ unit: 'metric' }), 'bottom-right');
		
		  map.on('load', async () => {
		
		    document.getElementById('map').addEventListener('wheel', e => e.stopPropagation());
		    document.getElementById('map').addEventListener('touchmove', e => e.stopPropagation());
		    
		  try {
		// 1) Load Singapore boundary - Add error handling
		try {
		  const sgBoundaryResponse = await fetch('https://raw.githubusercontent.com/carionb/Local/main/MasterPlan2019RegionBoundaryNoSeaGEOJSON.geojson');
		  if (!sgBoundaryResponse.ok) {
		    throw new Error(`Failed to load boundary: ${sgBoundaryResponse.status}`);
		  }
		  const sgBoundaryData = await sgBoundaryResponse.json();
		  
		  map.addSource('sg-boundary', {
		    type: 'geojson',
		    data: sgBoundaryData
		  });
		  
		  map.addLayer({
		    id: 'sg-boundary-line',
		    type: 'line',
		    source: 'sg-boundary',
		    paint: {
		      'line-color': '#0a0a0a',
		      'line-width': 1
		    }
		  });
		  console.log('Singapore boundary loaded successfully');
		} catch (err) {
		  console.warn('Error loading Singapore boundary:', err);
		  // Continue anyway - this isn't critical for tooltips
		}
		
		// 2) Load HDB GeoJSON with better error handling
		let hdbData;
		try {
		  const resp = await fetch('https://raw.githubusercontent.com/carionb/Local/main/HDB_description_floor_year.geojson');
		
		  if (!resp.ok) {
		    throw new Error(`Failed to load HDB data: ${resp.status}`);
		  }
		  hdbData = await resp.json();
		  console.log('HDB data loaded successfully');
		} catch (err) {
		  console.warn('Error loading HDB data:', err);
		  // Fallback to test data so tooltip can be demonstrated
		  console.log('Using fallback test HDB data');
		  hdbData = {
		    "type": "FeatureCollection",
		    "features": [
		      {
		        "type": "Feature",
		        "properties": {
		          "FLOOR": 12,
		          "YEAR": 1985,
		          "descriptio": "<table><tr><th>BLK_NO</th><td>123</td></tr><tr><th>STREET</th><td>Clementi Road</td></tr></table>"
		        },
		        "geometry": {
		          "type": "Polygon",
		          "coordinates": [[[103.8, 1.35], [103.81, 1.35], [103.81, 1.36], [103.8, 1.36], [103.8, 1.35]]]
		        }
		      },
		      {
		        "type": "Feature",
		        "properties": {
		          "floor": 25,
		          "year": 2005,
		          "descriptio": "<table><tr><th>Blk_No</th><td>456</td></tr><tr><th>Street</th><td>Orchard Road</td></tr></table>"
		        },
		        "geometry": {
		          "type": "Polygon",
		          "coordinates": [[[103.82, 1.37], [103.83, 1.37], [103.83, 1.38], [103.82, 1.38], [103.82, 1.37]]]
		        }
		      }
		    ]
		  };
		}
		
		// Now add the HDB data to the map
		map.addSource('hdb', {
		  type: 'geojson',
		  data: hdbData,
		  generateId: true
		});
		
		// 3) Year slider setup with error handling
		const years = hdbData.features
		  .map(f => f.properties.YEAR || f.properties.year)
		  .filter(y => y && y >= 1950 && y <= 2024); 
		
		const minY = years.length > 0 ? Math.min(...years) : 1950;
		const maxY = years.length > 0 ? Math.max(...years) : 2024;
		
		const slider = document.getElementById('year-slider');
		const label = document.getElementById('year-value');
		slider.min = minY; 
		slider.max = maxY; 
		slider.value = maxY;
		label.textContent = maxY;
		
		// 4) Single extrusion layer with color expression for hover
		map.addLayer({
		  id: 'hdb-3d',
		  type: 'fill-extrusion',
		  source: 'hdb',
		  paint: {
		    // if hovered â†’ yellow, else grey
		    'fill-extrusion-color': [
		      'case',
		      ['boolean', ['feature-state','hover'], false],
		      '#ffeb3b',
		      '#cccccc'
		    ],
		    'fill-extrusion-height': ['*',
		      ['coalesce', ['get','FLOOR'], ['get','floor'], 1], 3
		    ],
		    'fill-extrusion-opacity': 0.85,
		    'fill-extrusion-vertical-gradient': true
		  }
		});
		
		function parseDesc(html) {
		  if (!html) return { block: 'N/A', street: 'N/A' };
		  
		  try {
		const parser = new DOMParser();
		const doc = parser.parseFromString(decodeEntities(html), 'text/html');
		const rows = doc.querySelectorAll('tr');
		const data = {};
		
		rows.forEach(row => {
		  const th = row.querySelector('th')?.textContent?.trim().toLowerCase();
		  const td = row.querySelector('td')?.textContent?.trim();
		  if (th && td) {
		    if (th.includes('blk')) data.block = td;
		    if (th.includes('street')) data.street = td;
		  }
		});
		
		return {
		  block: data.block || 'N/A',
		  street: data.street || 'N/A'
		};
		  } catch (e) {
		console.warn('Error parsing description:', e);
		return { block: 'Error', street: 'Error' };
		  }
		}
		// Hover interaction with better error handling
		
		let hoveredId = null;
		const buildingInfo = document.getElementById('building-info');
		
		map.on('mousemove', 'hdb-3d', (e) => {
		  try {
		if (e.features.length === 0) return;
		
		if (hoveredId !== null) {
		  map.setFeatureState({ source: 'hdb', id: hoveredId }, { hover: false });
		}
		
		hoveredId = e.features[0].id;
		map.setFeatureState({ source: 'hdb', id: hoveredId }, { hover: true });
		
		const p = e.features[0].properties;
		
		// fix 
		const desc = parseDesc(p.descriptio || p.description || '');
		const year = p.YEAR || p.year || 'N/A';
		const floors = p.FLOOR || p.floor || 'N/A';
		
		buildingInfo.innerHTML = `
		  <div class="building-info-row">
		    <div class="building-info-label">Block</div>
		    <div class="building-info-value">${desc.block}</div> 
		  </div>
		  <div class="building-info-row">
		    <div class="building-info-label">Street</div>
		    <div class="building-info-value">${desc.street}</div>
		  </div>
		  <div class="building-info-row">
		    <div class="building-info-label">Year</div>
		    <div class="building-info-value">${year}</div>
		  </div>
		  <div class="building-info-row">
		    <div class="building-info-label">Floors</div>
		    <div class="building-info-value">${floors}</div>
		  </div>
		`;
		
		  } catch (err) {
		console.error('Error in mousemove handler:', err);
		
		buildingInfo.innerHTML = `
		  <div class="no-building-selected">
		    Information currently unavailable
		  </div>
		`;
		  }
		});
		
		map.on('mouseleave', 'hdb-3d', () => {
		  try {
		if (hoveredId !== null) {
		  map.setFeatureState({ source: 'hdb', id: hoveredId }, { hover: false });
		}
		hoveredId = null;
		buildingInfo.innerHTML = `
		  <div class="no-building-selected">
		    Hover over a building to see details
		  </div>
		`;
		  } catch (err) {
		console.error('Error in mouseleave handler:', err);
		  }
		});
		
		// 6) Year filter
		slider.oninput = e => {
		  try {
		    const y = +e.target.value;
		    label.textContent = y;
		    map.setFilter('hdb-3d', [
		      '<=', ['coalesce', ['get', 'YEAR'], ['get', 'year'], 0], y
		    ]);
		  } catch (err) {
		    console.error('Error in slider handler:', err);
		  }
		};
		
		// 7) Remote-control actions remain the same
		function ease(opts) { 
		  map.easeTo(Object.assign({ duration: 500 }, opts)); 
		}
		
		document.getElementById('tilt-up').onclick = () => {
		  currentPitch = Math.min(85, currentPitch + pitchStep);
		  ease({ pitch: currentPitch });
		};
		document.getElementById('tilt-down').onclick = () => {
		  currentPitch = Math.max(0, currentPitch - pitchStep);
		  ease({ pitch: currentPitch });
		};
		document.getElementById('reset-view').onclick = () => {
		  currentPitch = initialPitch;
		  ease({
		    center: initialCenter,
		    zoom: initialZoom,
		    pitch: initialPitch,
		    bearing: initialBearing
		  });
		};
		document.getElementById('rotate-right').onclick = () => {
		  ease({ bearing: map.getBearing() - bearingStep });
		};
		document.getElementById('rotate-left').onclick = () => {
		  ease({ bearing: map.getBearing() + bearingStep });
		};
		
		console.log('Map initialization complete');
		  } catch (err) {
		console.error('Fatal error in map initialization:', err);
		  }
		});    
		});
		
		// Population dashboard logic
		document.addEventListener('DOMContentLoaded', function() {
		var rawData, years;
		var trendChart = null;
		var startYearChart = null;
		var endYearChart = null;
		
		// 1. Load CSV
		fetch('https://raw.githubusercontent.com/carionb/Local/main/POPULATION.csv')
		    .then(function(r) { return r.text(); })
		    .then(function(text) {
		        var header = text.trim().split('\n')[0];
		        var lines = text.trim().split('\n').slice(1);
		        var cols = header.split(',').slice(1);
		        rawData = lines.map(function(line) {
		            var vals = line.split(',');
		            var obj = { series: vals[0] };
		            cols.forEach(function(col, i) {
		                obj[col] = vals[i+1] === 'na' ? null : +vals[i+1];
		            });
		            return obj;
		        });
		        years = cols.filter(function(c) { return /^\d+$/.test(c); })
		                   .map(function(y) { return +y; })
		                   .sort(function(a, b) { return a - b; });
		        initControls();
		        updateDashboard();
		    });
		
		// Helper function to get values from data
		function getVal(series, year) {
		    var row = rawData.find(function(r) { return r.series === series; });
		    return row ? row[year] : null;
		}
		
		// 2. Initialize selectors and toggle
		function initControls() {
		    var s = document.getElementById('startYear');
		    var e = document.getElementById('endYear');
		    var btn = document.getElementById('updateBtn');
		    var tog = document.getElementById('toggleComposition');
		
		    years.forEach(function(y) {
		        s.add(new Option(y, y));
		        e.add(new Option(y, y));
		    });
		    s.value = years[Math.max(0, years.length - 20)];
		    e.value = years[years.length - 1];
		    btn.onclick = updateDashboard;
		    tog.onchange = function() {
		        document.getElementById('compositionContainer').style.display = tog.checked ? 'block' : 'none';
		    };
		}
		
		// 3. Update all displays
		function updateDashboard() {
		    var startY = +document.getElementById('startYear').value;
		    var endY = +document.getElementById('endYear').value;
		    var span = years.filter(function(y) { return y >= startY && y <= endY; });
		
		    // 4. KPI cards
		    var startPop = getVal('Total Population (Number)', startY);
		    var endPop = getVal('Total Population (Number)', endY);
		    document.getElementById('currentPopulation').textContent = 
		        endPop != null ? endPop.toLocaleString() : 'â€“';
		    document.getElementById('populationChange').textContent = 
		        (startPop && endPop) ? 
		        ((endPop - startPop)/startPop*100).toFixed(1) + '%' : 'N/A';
		
		    var startAge = getVal('Median Age Of Resident Population (Years)', startY);
		    var endAge = getVal('Median Age Of Resident Population (Years)', endY);
		    document.getElementById('currentMedianAge').textContent = 
		        endAge != null ? endAge : 'â€“';
		    document.getElementById('medianAgeChange').textContent = 
		        (startAge && endAge) ? 
		        (endAge - startAge).toFixed(1) + ' yrs' : 'N/A';
		
		    var startSr = getVal('Old-Age Support Ratio: Residents Aged 15-64 Years Per Resident Aged 65 Years & Over (Number)', startY);
		    var endSr = getVal('Old-Age Support Ratio: Residents Aged 15-64 Years Per Resident Aged 65 Years & Over (Number)', endY);
		    document.getElementById('currentSupportRatio').textContent = 
		        endSr != null ? endSr : 'â€“';
		    document.getElementById('supportRatioChange').textContent = 
		        (startSr && endSr) ? 
		        (endSr - startSr).toFixed(1) : 'N/A';
		
		    // 5. Trend chart
		    var ctx1 = document.getElementById('populationTrendChart').getContext('2d');
		    if (trendChart) trendChart.destroy();
		    trendChart = new Chart(ctx1, {
		        type: 'line',
		        data: {
		            labels: span,
		            datasets: [{
		                label: 'Total Population',
		                data: span.map(function(y) { return getVal('Total Population (Number)', y); }),
		                borderColor: '#cc0000',
		                fill: false,
		                tension: 0.3
		            }]
		        },
		        options: { responsive: true, maintainAspectRatio: false }
		    });
		
		    // 6. Update composition charts
		    updateCompositionCharts(startY, endY);
		}
		
		function updateCompositionCharts(startY, endY) {
		    // Obtain 2D drawing contexts from canvas elements
		    var ctxStart = document.getElementById('startYearChart').getContext('2d');
		    var ctxEnd = document.getElementById('endYearChart').getContext('2d');
		
		    // If charts already exist, destroy them to avoid memory leaks
		    if (startYearChart) {
		        startYearChart.destroy();
		    }
		    if (endYearChart) {
		        endYearChart.destroy();
		    }
		
		    // Helper: fetch the three population values for a given year
		    function fetchCompositionData(year) {
		        return [
		            getVal('Singapore Citizen Population (Number)', year) || 0,
		            getVal('Permanent Resident Population (Number)', year) || 0,
		            getVal('Non-Resident Population (Number)', year) || 0
		        ];
		    }
		
		    // Helper: create a pie chart with title and data
		    function createPieChart(ctx, data, title) {
		        return new Chart(ctx, {
		            type: 'pie',
		            data: {
		                labels: ['Citizens', 'PRs', 'Non-Residents'],
		                datasets: [{
		                    data: data,
		                    backgroundColor: ['#2ecc71', '#f39c12', '#e74c3c']
		                }]
		            },
		            options: {
		                responsive: true,
		                maintainAspectRatio: false,
		                plugins: {
		                    title: {
		                        display: true,
		                        text: title
		                    }
		                }
		            }
		        });
		    }
		
		    // Build and store the new chart instances
		    startYearChart = createPieChart(
		        ctxStart,
		        fetchCompositionData(startY),
		        startY + ' Composition'
		    );
		
		    endYearChart = createPieChart(
		        ctxEnd,
		        fetchCompositionData(endY),
		        endY + ' Composition'
		    );
		}
		});
		
	</script>
</body>
</html>
